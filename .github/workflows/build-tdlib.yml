# .github/workflows/build-tdlib.yml
name: Build TDLib (macOS, Linux & Windows)

on:
  workflow_dispatch:
    inputs:
      tdlib_version:
        description: "TDLib git tag (e.g. v1.8.5)"
        required: true
        default: "v1.8.5"

env:
  TDLIB_VERSION: ${{ inputs.tdlib_version }}

jobs:
  # ===================== macOS =====================
  build-macos:
    name: Build for macOS (ARM64)
    runs-on: macos-14
    steps:
      - name: Install dependencies
        run: brew install gperf cmake openssl

      - name: Checkout TDLib
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout $TDLIB_VERSION

      - name: Compile
        run: |
          cd td
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) \
                -DCMAKE_INSTALL_PREFIX:PATH=../../tdlib_macos ..
          cmake --build . --target install --parallel 4

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-macos-arm64-${{ env.TDLIB_VERSION }}
          path: tdlib_macos/

  # ===================== Linux =====================
  build-linux:
    name: Build for Linux (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y \
             build-essential gperf cmake openssl libssl-dev zlib1g-dev

      - name: Checkout TDLib
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout $TDLIB_VERSION

      - name: Compile
        run: |
          cd td
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX:PATH=../../tdlib_linux ..
          cmake --build . --target install --parallel 4

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-linux-amd64-${{ env.TDLIB_VERSION }}
          path: tdlib_linux/

  # ===================== Windows =====================
  build-windows:
    name: Build for Windows (x64)
    runs-on: windows-latest
    steps:
      - name: Install dependencies (vcpkg)
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=$PWD" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          .\vcpkg.exe install openssl:x64-windows zlib:x64-windows gperf:x64-windows

      - name: Checkout TDLib
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout $env:TDLIB_VERSION

      - name: Compile
        shell: cmd
        run: |
          cd td
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ^
                -DCMAKE_INSTALL_PREFIX:PATH=../../tdlib_windows ^
                -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake ..
          cmake --build . --target install --config Release --parallel 4

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-windows-amd64-${{ env.TDLIB_VERSION }}
          path: tdlib_windows/
