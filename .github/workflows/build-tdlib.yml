name: Build TDLib (Windows)

on:
  workflow_dispatch:

jobs:
  # ---------------- Windows ----------------
  build-windows:
    name: Build for Windows (x64)
    runs-on: windows-latest
    steps:
      - name: Checkout TDLib (pinned commit)
        run: |
            git clone https://github.com/tdlib/td.git
            cd td
            git checkout b28fdac251c87c7e5bec99ae58b684661af7431a


      - name: Install dependencies (vcpkg)
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          ./bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=$PWD" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          ./vcpkg.exe install openssl:x64-windows zlib:x64-windows gperf:x64-windows


      - name: Compile
        shell: cmd
        run: |
          cd td
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ^
                -DCMAKE_INSTALL_PREFIX:PATH=../../tdlib_windows ^
                -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%/scripts/buildsystems/vcpkg.cmake ..

          cmake --build . --target install --config Release --parallel 4

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-windows-amd64-${{ github.event.inputs.tdlib_version }}
          path: tdlib_windows/
